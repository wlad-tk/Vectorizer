/**
 * @author Srishan Bhattarai <srishanbhattarai@gmail.com>
 * Last Modified: 09.05.2017
 */
function Vectorizer(){const a=this;let b;return this.makeVector=((b,c,d)=>{d=d||{};a.handleOptions(d);a.imgLoader(b,b=>{c(a.makeSvgString(a.getImgdata(b),d))})}),this.makeSvgString=((b,c)=>{c=c||{};a.handleOptions(c);const d=a.imgDataToTraceVal(b,c);return a.getsvgstring(b.width*c.scale,b.height*c.scale,d,c)}),this.makeTraceValues=((b,c,d)=>{d=d||{};a.handleOptions(d);a.imgLoader(b,b=>{c(a.imgDataToTraceVal(a.getImgdata(b),d))})}),this.imgDataToTraceVal=((b,c)=>{c=c||{};a.handleOptions(c);const d=a.colorquantization(b,c.pal,c.numberofcolors,c.mincolorratio,c.colorquantcycles);const e=a.layering(d);c.layercontainerid&&a.createCanvasLayers(e,a.customPalette,c.scale,c.layercontainerid);const f=a.pathScanLayers(e,c.pathLengthThreshold);const g=a.internodeAllLayers(f);return{layers:a.traceAllLayers(g,c.lowerLinearThreshold,c.quadraticSplineThreshold),palette:d.palette,background:d.background}}),this.handleOptions=(a=>{a=a||{};a.lowerLinearThreshold=a.lowerLinearThreshold||1;a.quadraticSplineThreshold=a.quadraticSplineThreshold||1;a.pathLengthThreshold=a.pathLengthThreshold||8;a.numberofcolors=a.numberofcolors||16;a.mincolorratio=a.mincolorratio||.02;a.colorquantcycles=a.colorquantcycles||3;a.scale=2;a.lcpr=a.lcpr||0;a.qcpr=a.qcpr||0}),this.colorquantization=((b,c,d,e,f)=>{const g=[];let h=0;let i;let j;let k;let l;let m;let n;const o=[];const p=b.width*b.height;f=f||3;e=e||.2;d=d||16;for(var q=0;q<b.height+2;q++){g[q]=[];for(var r=0;r<b.width+2;r++)g[q][r]=-1}const s=c||a.generatepalette(d);for(let a=0;a<f;a++){if(a>0)for(var t=0;t<s.length;t++)o[t].n>0&&(s[t].r=Math.floor(o[t].r/o[t].n),s[t].g=Math.floor(o[t].g/o[t].n),s[t].b=Math.floor(o[t].b/o[t].n)),o[t].n/p<e&&a<f-1&&(s[t].r=Math.floor(255*Math.random()),s[t].g=Math.floor(255*Math.random()),s[t].b=Math.floor(255*Math.random()));for(var r=0;r<s.length;r++)o[r]={},o[r].r=0,o[r].g=0,o[r].b=0,o[r].n=0;for(var q=0;q<b.height;q++)for(var r=0;r<b.width;r++){h=4*(q*b.width+r),j=768,k=0;for(var t=0;t<s.length;t++)l=Math.abs(s[t].r-b.data[h]),m=Math.abs(s[t].g-b.data[h+1]),n=Math.abs(s[t].b-b.data[h+2]),(i=l+m+n)<j&&(j=i,k=t);o[k].r+=b.data[h],o[k].g+=b.data[h+1],o[k].b+=b.data[h+2],o[k].n++,g[q+1][r+1]=k}}return{array:g,palette:s,background:g[1][1]}}),this.generatepalette=(a=>{const b=[];if(a<8){const c=Math.floor(255/(a-1));for(let d=0;d<a;d++)b.push({r:d*c,g:d*c,b:d*c,a:255})}else{const d=Math.floor(Math.pow(a,1/3)),e=Math.floor(255/(d-1)),f=a-d*d*d;for(var c=0;c<d;c++)for(let a=0;a<d;a++)for(let f=0;f<d;f++){const d=c*e,g=a*e,h=f*e,i={r:d,g:g,b:h,a:255};b.push(i)}for(var c=0;c<f;c++)b.push({r:Math.floor(255*Math.random()),g:Math.floor(255*Math.random()),b:Math.floor(255*Math.random()),a:255})}return b}),this.layering=(a=>{const b=[];let c=0;const d=a.array.length;const e=a.array[0].length;let f;let g;let h;let i;let j;let k;let l;let m;for(let c=0;c<a.palette.length;c++){b[c]=[];for(var n=0;n<d;n++){b[c][n]=[];for(var o=0;o<e;o++)b[c][n][o]=0}}for(var n=1;n<d-1;n++)for(var o=1;o<e-1;o++)c=a.array[n][o],f=n>0&&o>0&&a.array[n-1][o-1]===c?1:0,g=n>0&&a.array[n-1][o]===c?1:0,h=n>0&&o<e-1&&a.array[n-1][o+1]===c?1:0,i=o>0&&a.array[n][o-1]===c?1:0,j=o<e-1&&a.array[n][o+1]===c?1:0,k=n<d-1&&o>0&&a.array[n+1][o-1]===c?1:0,l=n<d-1&&a.array[n+1][o]===c?1:0,m=n<d-1&&o<e-1&&a.array[n+1][o+1]===c?1:0,b[c][n+1][o+1]=1+2*j+4*m+8*l,i||(b[c][n+1][o]=2+4*l+8*k),g||(b[c][n][o+1]=0+2*h+4*j+8),f||(b[c][n][o]=0+2*g+4+8*i);return b}),this.scanPaths=((a,b)=>{b=b||8;const c=[];let d=0;let e=0;let f=0;let g=0;const h=a[0].length;const i=a.length;let j=0;let k=!0;let l=!1;let m=0;const n=h*i*2;for(let o=0;o<i;o++)for(let p=0;p<h;p++)if(0===a[o][p]||15===a[o][p])m++;else for(f=p,g=o,c[d]=[],k=!1,e=0,1===a[g][f]&&(j=0),2===a[g][f]&&(j=3),3===a[g][f]&&(j=0),4===a[g][f]&&(j=1,l=!1),5===a[g][f]&&(j=0),6===a[g][f]&&(j=3),7===a[g][f]&&(j=0,l=!0),8===a[g][f]&&(j=0),9===a[g][f]&&(j=3),10===a[g][f]&&(j=3),11===a[g][f]&&(j=1,l=!0),12===a[g][f]&&(j=0),13===a[g][f]&&(j=3,l=!0),14===a[g][f]&&(j=0,l=!0);!k;)c[d][e]={},c[d][e].x=f-1,c[d][e].y=g-1,c[d][e].t=a[g][f],1===a[g][f]?(a[g][f]=0,0===j?(g--,j=1):3===j?(f--,j=2):(k=!0,c.pop())):2===a[g][f]?(a[g][f]=0,3===j?(f++,j=0):2===j?(g--,j=1):(k=!0,c.pop())):3===a[g][f]?(a[g][f]=0,0===j?f++:2===j?f--:(k=!0,c.pop())):4===a[g][f]?(a[g][f]=0,1===j?(f++,j=0):2===j?(g++,j=3):(k=!0,c.pop())):5===a[g][f]?0===j?(a[g][f]=13,g++,j=3):1===j?(a[g][f]=13,f--,j=2):2===j?(a[g][f]=7,g--,j=1):3===j&&(a[g][f]=7,f++,j=0):6===a[g][f]?(a[g][f]=0,1===j?g--:3===j?g++:(k=!0,c.pop())):7===a[g][f]?(a[g][f]=0,0===j?(g++,j=3):1===j?(f--,j=2):(k=!0,c.pop())):8===a[g][f]?(a[g][f]=0,0===j?(g++,j=3):1===j?(f--,j=2):(k=!0,c.pop())):9===a[g][f]?(a[g][f]=0,1===j?g--:3===j?g++:(k=!0,c.pop())):10===a[g][f]?0===j?(a[g][f]=11,g--,j=1):1===j?(a[g][f]=14,f++,j=0):2===j?(a[g][f]=14,g++,j=3):3===j&&(a[g][f]=11,f--,j=2):11===a[g][f]?(a[g][f]=0,1===j?(f++,j=0):2===j?(g++,j=3):(k=!0,c.pop())):12===a[g][f]?(a[g][f]=0,0===j?f++:2===j?f--:(k=!0,c.pop())):13===a[g][f]?(a[g][f]=0,2===j?(g--,j=1):3===j?(f++,j=0):(k=!0,c.pop())):14===a[g][f]&&(a[g][f]=0,0===j?(g--,j=1):3===j?(f--,j=2):(k=!0,c.pop())),f-1===c[d][0].x&&g-1===c[d][0].y&&(k=!0,l||c[d].length<b?c.pop():d++),(f<0||f>=h||g<0||g>=i)&&(k=!0,console.log("path "+d+" error w "+h+" h "+i+" px "+f+" py "+g),c.pop()),m>n&&(k=!0,console.log("path "+d+" error stepcnt "+m+" maxsteps "+n+" px "+f+" py "+g),c.pop()),m++,e++;return c}),this.pathScanLayers=((c,d)=>{d=d||8;const e=[];for(b in c)c.hasOwnProperty(b)&&(e[b]=a.scanPaths(c[b],d));return e}),this.internodes=(a=>{const b=[];let c=0;let d=0;let e=0;let f=0;let g=0;for(let h=0;h<a.length;h++){b[h]=[],c=a[h].length;for(let i=0;i<c;i++)d=(i+1)%c,e=(i+2)%c,b[h][i]={},b[h][i].x=(a[h][i].x+a[h][d].x)/2,b[h][i].y=(a[h][i].y+a[h][d].y)/2,f=(a[h][d].x+a[h][e].x)/2,g=(a[h][d].y+a[h][e].y)/2,b[h][i].x<f?b[h][i].y<g?b[h][i].linesegment=1:b[h][i].y>g?b[h][i].linesegment=7:b[h][i].linesegment=0:b[h][i].x>f?b[h][i].y<g?b[h][i].linesegment=3:b[h][i].y>g?b[h][i].linesegment=5:b[h][i].linesegment=4:b[h][i].y<g?b[h][i].linesegment=2:b[h][i].y>g?b[h][i].linesegment=6:b[h][i].linesegment=8}return b}),this.internodeAllLayers=(c=>{const d=[];for(b in c)c.hasOwnProperty(b)&&(d[b]=a.internodes(c[b]));return d}),this.getPath=((b,c,d)=>{let f,g,h,e=0,i=[];for(;e<b.length;){for(f=b[e].linesegment,g=-1,h=e+1;(b[h].linesegment===f||b[h].linesegment===g||-1===g)&&h<b.length-1;)b[h].linesegment!==f&&-1===g&&(g=b[h].linesegment),h++;h===b.length-1&&(h=0),i=i.concat(a.fitseq(b,c,d,e,h)),e=h>0?h:b.length}return i}),this.fitseq=((b,c,d,e,f)=>{if(f>b.length||f<0)return[];let j,k,l,g=e,h=0,i=!0;let m=f-e;m<0&&(m+=b.length);const n=(b[f].x-b[e].x)/m,o=(b[f].y-b[e].y)/m;let q,p=(e+1)%b.length;for(;p!=f;)q=p-e,q<0&&(q+=b.length),j=b[e].x+n*q,k=b[e].y+o*q,l=(b[p].x-j)*(b[p].x-j)+(b[p].y-k)*(b[p].y-k),l>c&&(i=!1),l>h&&(g=p,h=l),p=(p+1)%b.length;if(i)return[{type:"L",x1:b[e].x,y1:b[e].y,x2:b[f].x,y2:b[f].y}];const r=g;i=!0;h=0;let s=(r-e)/m,t=(1-s)*(1-s),u=2*(1-s)*s,v=s*s;const w=(t*b[e].x+v*b[f].x-b[r].x)/-u,x=(t*b[e].y+v*b[f].y-b[r].y)/-u;p=e+1;for(;p!=f;)s=(p-e)/m,t=(1-s)*(1-s),u=2*(1-s)*s,v=s*s,j=t*b[e].x+u*w+v*b[f].x,k=t*b[e].y+u*x+v*b[f].y,l=(b[p].x-j)*(b[p].x-j)+(b[p].y-k)*(b[p].y-k),l>d&&(i=!1),l>h&&(g=p,h=l),p=(p+1)%b.length;if(i)return[{type:"Q",x1:b[e].x,y1:b[e].y,x2:w,y2:x,x3:b[f].x,y3:b[f].y}];const y=Math.floor((r+g)/2);let z=a.fitseq(b,c,d,e,y);z=z.concat(a.fitseq(b,c,d,y,f));return z}),this.traceAllPaths=((c,d,e)=>{const f=[];for(b in c)c.hasOwnProperty(b)&&f.push(a.getPath(c[b],d,e));return f}),this.traceAllLayers=((c,d,e)=>{const f=[];for(b in c)c.hasOwnProperty(b)&&(f[b]=a.traceAllPaths(c[b],d,e));return f}),this.svgpathstring=((a,b,c,d,e,f)=>{let g='<path desc="'+a+'" fill="'+c+'" stroke="'+c+'" stroke-width="1" d="';g+="M"+b[0].x1*d+" "+b[0].y1*d+" ";for(var h=0;h<b.length;h++)g+=b[h].type+" "+b[h].x2*d+" "+b[h].y2*d+" ",b[h].x3&&(g+=b[h].x3*d+" "+b[h].y3*d+" ");g+='Z " />';if(e&&f)for(var h=0;h<b.length;h++)b[h].x3?(g+='<circle cx="'+b[h].x2*d+'" cy="'+b[h].y2*d+'" r="'+f+'" fill="cyan" stroke-width="'+.2*f+'" stroke="black" />',g+='<circle cx="'+b[h].x3*d+'" cy="'+b[h].y3*d+'" r="'+f+'" fill="white" stroke-width="'+.2*f+'" stroke="black" />',g+='<line x1="'+b[h].x1*d+'" y1="'+b[h].y1*d+'" x2="'+b[h].x2*d+'" y2="'+b[h].y2*d+'" stroke-width="'+.2*f+'" stroke="cyan" />',g+='<line x1="'+b[h].x2*d+'" y1="'+b[h].y2*d+'" x2="'+b[h].x3*d+'" y2="'+b[h].y3*d+'" stroke-width="'+.2*f+'" stroke="cyan" />'):g+='<circle cx="'+b[h].x2*d+'" cy="'+b[h].y2*d+'" r="'+e+'" fill="white" stroke-width="'+.2*e+'" stroke="black" />';else if(e)for(var h=0;h<b.length;h++)b[h].x3||(g+='<circle cx="'+b[h].x2*d+'" cy="'+b[h].y2*d+'" r="'+e+'" fill="white" stroke-width="'+.2*e+'" stroke="black" />');else if(f)for(var h=0;h<b.length;h++)b[h].x3&&(g+='<circle cx="'+b[h].x2*d+'" cy="'+b[h].y2*d+'" r="'+f+'" fill="cyan" stroke-width="'+.2*f+'" stroke="black" />',g+='<circle cx="'+b[h].x3*d+'" cy="'+b[h].y3*d+'" r="'+f+'" fill="white" stroke-width="'+.2*f+'" stroke="black" />',g+='<line x1="'+b[h].x1*d+'" y1="'+b[h].y1*d+'" x2="'+b[h].x2*d+'" y2="'+b[h].y2*d+'" stroke-width="'+.2*f+'" stroke="cyan" />',g+='<line x1="'+b[h].x2*d+'" y1="'+b[h].y2*d+'" x2="'+b[h].x3*d+'" y2="'+b[h].y3*d+'" stroke-width="'+.2*f+'" stroke="cyan" />');return g}),this.getsvgstring=((b,c,d,e)=>{e=e||{};a.handleOptions(e);let f='<svg width="'+b+'px" height="'+c+'px" version="1.1" xmlns="http://www.w3.org/2000/svg" desc="Created with imagetracer.js" >';f+='<rect x="0" y="0" width="'+b+'px" height="'+c+'px" fill="'+a.torgbstr(d.palette[d.background])+'" />';const g=[];let h;for(l in d.layers)if(d.layers.hasOwnProperty(l))for(let a=0;a<d.layers[l].length;a++)h=d.layers[l][a][0].y1*b+d.layers[l][a][0].x1,g[h]={l:""+l,p:""+a};const i=Object.keys(g);let j;let k;i.sort(a.compareNumbers);for(var l=0;l<i.length;l++)j=g[i[l]].l,k=g[i[l]].p,f+=a.svgpathstring("l "+j+" p "+k,d.layers[j][k],a.torgbstr(d.palette[j]),e.scale,e.lcpr,e.qcpr);f+="</svg>";return f}),this.compareNumbers=((a,b)=>a-b),this.torgbstr=(a=>"rgb("+a.r+","+a.g+","+a.b+")"),this.SVGToContainer=((a,b)=>{let c;b?(c=document.getElementById(b))||(c=document.createElement("div"),c.id=b,document.body.appendChild(c)):(c=document.createElement("div"),document.body.appendChild(c));c.innerHTML+=a}),this.imgLoader=((a,b)=>{const c=new Image;c.src=a;c.onload=(()=>{const a=document.createElement("canvas");a.width=c.width;a.height=c.height;const d=a.getContext("2d");d.drawImage(c,0,0);b(a)})}),this.getImgdata=(a=>{const b=a.getContext("2d");return b.getImageData(0,0,a.width,a.height)}),this.customPalette=[{r:0,g:0,b:0,a:255},{r:128,g:128,b:128,a:255},{r:0,g:0,b:128,a:255},{r:64,g:64,b:128,a:255},{r:192,g:192,b:192,a:255},{r:255,g:255,b:255,a:255},{r:128,g:128,b:192,a:255},{r:0,g:0,b:192,a:255},{r:128,g:0,b:0,a:255},{r:128,g:64,b:64,a:255},{r:128,g:0,b:128,a:255},{r:168,g:168,b:168,a:255},{r:192,g:128,b:128,a:255},{r:192,g:0,b:0,a:255},{r:255,g:255,b:255,a:255},{r:0,g:128,b:0,a:255}],this.createCanvasLayers=((c,d,e,f)=>{e=e||1;let g,h;let j;f?(j=document.getElementById(f))||(j=document.createElement("div"),j.id=f,document.body.appendChild(j)):(vectorHolder=document.createElement("div"),document.body.appendChild(j));for(b in c)if(c.hasOwnProperty(b)){g=c[b][0].length,h=c[b].length,0;const f=document.createElement("canvas");f.width=g*e,f.height=h*e;const j=f.getContext("2d");for(let f=0;f<h;f++)for(let h=0;h<g;h++)j.fillStyle=a.torgbstr(d[c[b][f][h]%d.length]),j.fillRect(h*e,f*e,e,e);vectorHolder.appendChild(f)}}),this}
